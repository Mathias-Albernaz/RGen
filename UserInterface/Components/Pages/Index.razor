@page "/"
@rendermode InteractiveServer

@using System.ComponentModel.DataAnnotations
@using Controladores
@using Dominio
@using UserInterface.Components.Shared
@using Repositorio
@inject IDialogService DialogService
@inject ControladorItems ControladorItems
@inject ControladorDatos ControladorDatos
@inject  ControladorRecibos ControladorRecibos
@inject ItemMemoryRepo ItemMemoryRepo

<MudPopoverProvider/>
<MudDialogProvider/>
<MudSnackbarProvider/>

<MudText Typo="Typo.h2" Align="Align.Center">Nuevo Recibo</MudText>
<MudContainer MaxWidth="MaxWidth.Small">
    <EditForm Model="@model" OnValidSubmit="OnValidSubmit">
        <DataAnnotationsValidator/>
        <MudCard>
            <MudCardContent>
                <MudTextField MaxLength="50" Label="Titulo*" HelperText="Max. 50 characters"
                              @bind-Value="model.Titulo" For="@(() => model.Titulo)" />
                <MudTextField MaxLength="2" Label="Autor*" HelperText="Iniciales" Class="mt-3"
                              @bind-Value="model.Autor" For="@(() => model.Autor)"/>
                <MudTextField Label="Destinatario*" Class="mt-3"
                              @bind-Value="model.Destinatario" For="@(() => model.Destinatario)"/>
                <div style="height: 30px"></div>
                <MudDatePicker @bind-Date="model.Fecha" Label="Fecha de entrega*"/>
                <MudTextField Label="Observaciones" HelperText="Opcional" Class="mt-3"
                              @bind-Value="model.Observacion" For="@(() => model.Observacion)"/>
            </MudCardContent>
        </MudCard>
        <MudDivider DividerType="DividerType.Middle" Class="my-8"/>
        <MudText Typo="Typo.h5" Align="Align.Center">Elementos</MudText>
        <MudSimpleTable Dense="false" FixedHeader="true" Style="@(true ? "height:200px;" : "")" Striped="true" Outlined="true">
            <thead>
            <tr>
                @foreach (var h in headings)
                {
                    <th>@h</th>
                }
            </tr>
            </thead>
            <tbody>
            @foreach (var row in _itemsMemoryList)
            {
                <tr>
                    @foreach (var x in row.ToString().Split(","))
                    {
                        <td>@x</td>
                    }
                </tr>
            }
            </tbody>
        </MudSimpleTable>
        <MudButton ButtonType="ButtonType.Button" Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" Class="ml-auto" @onclick="OpenDialogAsync">Agregar Item</MudButton>

        <MudDivider DividerType="DividerType.Middle" Class="my-1"/>
        @if (!completado)
        {
            <MudContainer Style="display: flex; justify-content: center">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
            </MudContainer>
        }
        <MudCardActions>
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" Size="Size.Medium" FullWidth="true">Crear</MudButton>
        </MudCardActions>
    </EditForm>
</MudContainer>


@code {
    List<Item> _itemsMemoryList;
    List<Item> _items;
    Form model = new Form();
    bool success;
    bool completado;
    string[] headings = { "Cantidad", "Descripcion", "Identificador" };
    
    protected override void OnInitialized()
    {
        _itemsMemoryList = new List<Item>();
        _items = new List<Item>();
        completado = true;
        model.Fecha = DateTime.Today;
        StateHasChanged();
    }

    public class Form
    {
        [Required]
        [StringLength(50)]
        public string Titulo { get; set; }

        [Required]
        [StringLength(2)]
        public string Autor { get; set; }

        [Required]
        public string Destinatario { get; set; }

        [Required] 
        public DateTime? Fecha { get; set; }
        
        public string Observacion { get; set; }
        
    }

    private async void OnValidSubmit(EditContext context)
    {
        completado = false;
        Dato _dato = ControladorDatos.AgregarDatos(model.Titulo, model.Autor, model.Destinatario, model.Fecha, model.Observacion);
        foreach (var item in _itemsMemoryList)
        {
            _items.Add(ControladorItems.AgregarItem(item.Cantidad, item.Descripcion, item.Identificador));
        }
        success = true;
        ControladorRecibos.AgregarRecibo(_items, _dato); 
        completado = true;
        model = new Form();
        _itemsMemoryList.Clear();
        _items.Clear();
        StateHasChanged();
    }
    
    private async Task OpenDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var dialog = DialogService.Show<FormDialog>("Agregar Elemento", options);
        var result = await dialog.Result;
    
        if (!result.Canceled)
        {
            _itemsMemoryList = ItemMemoryRepo.Listar();
            StateHasChanged();
        }
        
        
    }
    

}